version: "3.7"

services:
  fuzzysearch:
    image: 461183108257.dkr.ecr.eu-west-2.amazonaws.com/uec-dos-api/sfs/dos-service-fuzzy-search-api:latest
    container_name: fuzzysearch
    environment:
      SPRING_PROFILES_ACTIVE: $SPRING_PROFILES_ACTIVE
      URL: $URL
      SERVER_PORT: $SERVER_PORT
      VERSION: $VERSION
      MIN_SEARCH_TERM_LENGTH: $MIN_SEARCH_TERM_LENGTH
      MAX_SEARCH_CRITERIA: $MAX_SEARCH_CRITERIA
      MAX_NUM_SERVICES_TO_RETURN: $MAX_NUM_SERVICES_TO_RETURN
    ports:
      - 9095:9095
    command: ["java", "-jar", "/application/dos-service-fuzzy-search-api.jar"]
    networks:
      default:
        aliases:
          - fuzzysearch.sfs.local

  elasticsearch:
    image: nhsd/elasticsearch:$DOCKER_LIBRARY_ELASTICSEARCH_VERSION
    container_name: elasticsearch
    hostname: elasticsearch
    ports:
      - "9200:9200"
    command: ["elasticsearch"]
    networks:
      default:
        aliases:
          - elasticsearch.sfs.local

  elasticsearch:
    image: elasticsearch:$DOCKER_ELASTICSEARCH_VERSION
    container_name: elasticsearch
    hostname: elasticsearch
    user: elasticsearch
    environment:
      ES_JAVA_OPTS: "-Xms64m -Xmx128m"
    ports:
      - "9200:9200"
    command: >
      /bin/bash -c "
        elasticsearch \
          -E discovery.type=single-node \
          -E http.port=9200 \
          -E http.cors.enabled=true \
          -E http.cors.allow-origin=http://localhost:1358,http://127.0.0.1:1358 \
          -E http.cors.allow-headers=X-Requested-With,X-Auth-Token,Content-Type,Content-Length,Authorization \
          -E http.cors.allow-credentials=true; "
    networks:
      default:
        aliases:
          - elasticsearch.sf.test

  kibana:
    image: docker.elastic.co/kibana/kibana:7.9.2
    container_name: kibana
    environment:
      SERVER_HOST: "0.0.0.0"
      SERVER_PORT: 5601
      SERVER_NAME: kibana
      ELASTICSEARCH_HOSTS: http://elasticsearch.sf.test:9200
    ports:
      - "5601:5601"
    depends_on:
      - elasticsearch
    networks:
      default:
        aliases:
          - kibana.sf.test

networks:
  default:
    external:
      name: $DOCKER_NETWORK
